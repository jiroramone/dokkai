<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>発達支援アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container bg-white shadow-xl rounded-2xl p-6 md:p-10 text-center">
        <!-- Main Title -->
        <h1 class="text-3xl md:text-5xl font-bold text-gray-800 mb-6 md:mb-10">ぶんしょうどっかいげーむ</h1>

        <!-- Level Selection -->
        <div id="level-selection" class="space-y-4 mb-6 md:mb-10">
            <h2 class="text-xl md:text-3xl font-bold text-gray-700">れべるを えらんでね</h2>
            <div class="flex flex-col space-y-4 md:space-y-0 md:flex-row md:space-x-4">
                <button id="level-1-btn" class="flex-1 py-3 px-6 rounded-full font-bold transition-all duration-300 text-white bg-blue-500 hover:bg-blue-600 shadow-md transform hover:scale-105">
                    れべる１（せんたくしき）
                </button>
                <button id="level-2-btn" class="flex-1 py-3 px-6 rounded-full font-bold transition-all duration-300 text-white bg-green-500 hover:bg-green-600 shadow-md transform hover:scale-105">
                    れべる２（あなうめしき）
                </button>
                <button id="level-3-btn" class="flex-1 py-3 px-6 rounded-full font-bold transition-all duration-300 text-white bg-orange-500 hover:bg-orange-600 shadow-md transform hover:scale-105">
                    れべる３（きじゅつしき）
                </button>
            </div>
        </div>

        <!-- Game Area -->
        <div id="game-area" class="space-y-6 hidden">

            <!-- Content Area (Story/Scenario) -->
            <div id="content-display" class="bg-gray-50 p-6 rounded-lg shadow-inner min-h-[150px] flex items-center justify-center text-left">
                <p id="game-text" class="text-lg md:text-xl text-gray-700 leading-relaxed"></p>
            </div>

            <!-- Question/Prompt Area -->
            <div id="prompt-display" class="bg-gray-100 p-4 rounded-lg shadow-sm">
                <p id="game-prompt" class="text-xl md:text-2xl font-bold text-gray-800"></p>
            </div>

            <!-- Answer Options for Level 1 -->
            <div id="options-container" class="grid gap-4 sm:grid-cols-2">
                <!-- Buttons will be injected here by JavaScript for Level 1 -->
            </div>
            
            <!-- Fill-in-the-blank input for Level 2 -->
            <div id="fill-in-the-blank-container" class="hidden flex items-center justify-center space-x-2">
                <input type="text" id="answer-input" placeholder="こたえをにゅうりょく" class="w-2/3 p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500">
                <button id="submit-btn" class="py-3 px-6 rounded-full font-bold text-white bg-blue-500 hover:bg-blue-600 shadow-md transform transition-all duration-300 hover:scale-105">
                    かいとうする
                </button>
            </div>

            <!-- Descriptive input for Level 3 -->
            <div id="descriptive-container" class="hidden flex flex-col items-center justify-center space-y-4">
                <textarea id="descriptive-answer-input" placeholder="ものがたりをよんで、ないようをせつめいしてください" rows="5" class="w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-blue-500"></textarea>
                <div class="flex space-x-4 w-full">
                    <button id="descriptive-submit-btn" class="flex-1 py-3 px-6 rounded-full font-bold text-white bg-blue-500 hover:bg-blue-600 shadow-md transform transition-all duration-300 hover:scale-105">
                        かいとうする
                    </button>
                    <!-- Loading indicator for API call -->
                    <div id="loading-spinner" class="hidden flex-1 py-3 px-6 rounded-full font-bold text-white bg-gray-400 items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ひょうかちゅう...
                    </div>
                </div>
            </div>

            <!-- Feedback Message -->
            <div id="feedback-container" class="min-h-[50px] flex items-center justify-center">
                <p id="feedback-message" class="text-2xl font-bold"></p>
            </div>

            <!-- Navigation Button -->
            <button id="next-btn" class="w-full py-4 px-8 rounded-full font-bold text-white bg-green-500 hover:bg-green-600 shadow-lg transform transition-all duration-300 hover:scale-105 hidden">
                つぎへ
            </button>

            <!-- Back to Title Button -->
            <button id="back-to-title-btn" class="w-full py-4 px-8 rounded-full font-bold text-white bg-gray-500 hover:bg-gray-600 shadow-lg transform transition-all duration-300 hover:scale-105 hidden">
                たいとるにもどる
            </button>
        </div>
    </div>

    <script>
        // Game data structured by level.
        const readingData = {
            level1: [
                {
                    text: "けんたは こうえんで、ねこを みつけました。ねこは きの うえに のぼって おりられなくなっていました。けんたは しんぱいに なり、おかあさんを よびに いきました。おかあさんが きたとき、ねこは ぶじに おりてきました。",
                    prompt: "けんたが みつけた どうぶつは なにですか？",
                    options: ["いぬ", "ねこ", "とり"],
                    correct: 1
                },
                {
                    text: "りなは あたらしい えほんを もらいました。とても うれしかったので、すぐに よみはじめました。えほんの なかには、そらを とぶ ぺんぎんの おはなしが かいてありました。りなは、その ぺんぎんに 「ぺぺ」という なまえを つけました。",
                    prompt: "りなが あたらしい えほんを もらったとき、どんな きもちでしたか？",
                    options: ["かなしい", "うれしい", "おこっている"],
                    correct: 1
                }
            ],
            level2: [
                {
                    text: "きょうは、とても いい てんきです。ひなたは、こうえんで ともだちと 〇〇で あそびました。",
                    answer: "ぼーる",
                    prompt: "〇〇に はいる ことばは なにですか？"
                },
                {
                    text: "あさ、めが さめると、まどの そとは 〇〇でした。きょうは えんそくの ひだったのに、ちゅうしに なってしまいました。",
                    answer: "あめ",
                    prompt: "〇〇に はいる ことばは なにですか？"
                }
            ],
            level3: [
                {
                    text: "りょうたは、なつやすみに おばあちゃんの いえへ いきました。おばあちゃんは、りょうたの ために、たくさんの おいしい りょうりを つくってくれました。りょうたは、おばあちゃんが つくってくれた かれーらいすが いちばん すきでした。",
                    prompt: "りょうたは なつやすみに どこへ いきましたか？また、いちばん すきな りょうりは なんでしたか？"
                },
                {
                    text: "ゆうきは、がっこうの かえりみちに おおきな いぬを みつけました。いぬは みちに まよっているようで、おどおどしていました。ゆうきは、いぬが くびに つけていた なふだを みて、かいぬしの でんわばんごうに れんらくしました。かいぬしさんが むかえに きてくれて、いぬは ぶじに いえに かえることが できました。",
                    prompt: "ゆうきは どのようして いぬを たすけましたか？"
                }
            ]
        };

        // Global variables
        let currentLevel = null;
        let currentQuestionIndex = 0;
        let gameData = [];

        // UI Elements
        const levelSelection = document.getElementById('level-selection');
        const level1Btn = document.getElementById('level-1-btn');
        const level2Btn = document.getElementById('level-2-btn');
        const level3Btn = document.getElementById('level-3-btn');
        const gameArea = document.getElementById('game-area');
        const gameText = document.getElementById('game-text');
        const gamePrompt = document.getElementById('game-prompt');
        const optionsContainer = document.getElementById('options-container');
        const fillInTheBlankContainer = document.getElementById('fill-in-the-blank-container');
        const answerInput = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-btn');
        const descriptiveContainer = document.getElementById('descriptive-container');
        const descriptiveAnswerInput = document.getElementById('descriptive-answer-input');
        const descriptiveSubmitBtn = document.getElementById('descriptive-submit-btn');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextBtn = document.getElementById('next-btn');
        const backToTitleBtn = document.getElementById('back-to-title-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const contentDisplay = document.getElementById('content-display');

        /**
         * Retries a function with exponential backoff.
         * @param {Function} fn The function to retry.
         * @param {number} retries The number of retries left.
         * @param {number} delay The initial delay in milliseconds.
         */
        async function retryWithBackoff(fn, retries = 5, delay = 1000) {
            try {
                return await fn();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return retryWithBackoff(fn, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        /**
         * Calls the Gemini API to evaluate a descriptive answer.
         * @param {string} text The story text.
         * @param {string} userAnswer The user's answer.
         */
        async function evaluateAnswerWithAI(text, userAnswer) {
            const prompt = `以下の物語とユーザーの回答を比較して、ユーザーの回答が物語の内容を正しく理解しているかどうかを評価してください。評価は『正解』または『不正解』のどちらかで、その理由も日本語で簡潔に説明してください。
物語: ${text}
ユーザーの回答: ${userAnswer}
`;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await retryWithBackoff(async () => {
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    throw new Error(`API call failed: ${res.statusText}`);
                }
                return res.json();
            });

            const result = response.candidates[0].content.parts[0].text;
            return result;
        }

        /**
         * Initializes the game for a selected level.
         * @param {number} level The level to start (1, 2, or 3).
         */
        function initializeGame(level) {
            currentLevel = level;
            gameData = readingData[`level${level}`];
            currentQuestionIndex = 0;
            
            levelSelection.classList.add('hidden');
            gameArea.classList.remove('hidden');
            
            displayQuestion();
        }
        
        /**
         * Returns the game to the title screen.
         */
        function backToTitle() {
            gameArea.classList.add('hidden');
            levelSelection.classList.remove('hidden');
        }

        /**
         * Displays the current question or scenario based on the level.
         */
        function displayQuestion() {
            // Check if all questions have been answered
            if (currentQuestionIndex >= gameData.length) {
                gameText.textContent = "おしまい！よく がんばりました！";
                gamePrompt.textContent = "";
                optionsContainer.innerHTML = "";
                fillInTheBlankContainer.classList.add('hidden');
                descriptiveContainer.classList.add('hidden');
                nextBtn.classList.add('hidden');
                backToTitleBtn.classList.remove('hidden');
                feedbackMessage.textContent = "";
                return;
            }

            const currentItem = gameData[currentQuestionIndex];
            
            // Reset UI for the new question
            gameText.textContent = currentItem.text;
            gamePrompt.textContent = currentItem.prompt;
            optionsContainer.classList.add('hidden');
            fillInTheBlankContainer.classList.add('hidden');
            descriptiveContainer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            backToTitleBtn.classList.add('hidden');
            feedbackMessage.textContent = "";
            answerInput.value = "";
            descriptiveAnswerInput.value = "";

            // Show UI elements based on the current level
            if (currentLevel === 1) {
                optionsContainer.classList.remove('hidden');
                optionsContainer.innerHTML = "";
                currentItem.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.classList.add(
                        'py-3', 'px-6', 'rounded-xl', 'font-bold', 'text-gray-800', 
                        'bg-gray-200', 'hover:bg-blue-300', 'transition-all', 'duration-300',
                        'shadow-sm', 'hover:shadow-lg', 'transform', 'hover:scale-105'
                    );
                    button.addEventListener('click', () => handleAnswer(index));
                    optionsContainer.appendChild(button);
                });
            } else if (currentLevel === 2) {
                fillInTheBlankContainer.classList.remove('hidden');
            } else if (currentLevel === 3) {
                descriptiveContainer.classList.remove('hidden');
            }
        }

        /**
         * Handles the user's answer choice for Level 1 and 2.
         * @param {number} selectedIndex The index of the selected option.
         */
        function handleAnswer(selectedIndex) {
            const currentItem = gameData[currentQuestionIndex];
            
            if (currentLevel === 1) {
                // Disable all buttons after an answer is selected
                Array.from(optionsContainer.children).forEach(button => {
                    button.disabled = true;
                });

                if (selectedIndex === currentItem.correct) {
                    feedbackMessage.textContent = "せいかい！";
                    feedbackMessage.classList.add('text-green-600');
                    feedbackMessage.classList.remove('text-red-600');
                } else {
                    feedbackMessage.textContent = "ざんねん...もういちど かんがえてみよう！";
                    feedbackMessage.classList.add('text-red-600');
                    feedbackMessage.classList.remove('text-green-600');
                }
                nextBtn.classList.remove('hidden');

            } else if (currentLevel === 2) {
                const userAnswer = answerInput.value.trim();
                if (userAnswer === currentItem.answer) {
                    feedbackMessage.textContent = "せいかい！";
                    feedbackMessage.classList.add('text-green-600');
                    feedbackMessage.classList.remove('text-red-600');
                } else {
                    feedbackMessage.textContent = "ざんねん...もういちど かんがえてみよう！";
                    feedbackMessage.classList.add('text-red-600');
                    feedbackMessage.classList.remove('text-green-600');
                }
                nextBtn.classList.remove('hidden');
            }
        }

        /**
         * Handles the user's descriptive answer for Level 3.
         */
        async function handleDescriptiveAnswer() {
            const userAnswer = descriptiveAnswerInput.value.trim();
            if (!userAnswer) {
                feedbackMessage.textContent = "かいとうを にゅうりょくしてください。";
                feedbackMessage.classList.add('text-red-600');
                return;
            }

            const currentItem = gameData[currentQuestionIndex];
            
            descriptiveSubmitBtn.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            
            try {
                const evaluationResult = await evaluateAnswerWithAI(currentItem.text, userAnswer);
                feedbackMessage.textContent = evaluationResult;
                feedbackMessage.classList.remove('text-green-600', 'text-red-600');
                nextBtn.classList.remove('hidden');
            } catch (error) {
                console.error("AI評価中にエラーが発生しました:", error);
                feedbackMessage.textContent = "ひょうかちゅうに エラーが はっせいしました。もういちどためしてください。";
                feedbackMessage.classList.add('text-red-600');
                descriptiveSubmitBtn.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Moves to the next question.
         */
        function goToNextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        // Event Listeners
        level1Btn.addEventListener('click', () => initializeGame(1));
        level2Btn.addEventListener('click', () => initializeGame(2));
        level3Btn.addEventListener('click', () => initializeGame(3));
        submitBtn.addEventListener('click', () => handleAnswer(null));
        descriptiveSubmitBtn.addEventListener('click', handleDescriptiveAnswer);
        nextBtn.addEventListener('click', goToNextQuestion);
        backToTitleBtn.addEventListener('click', backToTitle);

        // Initial setup
        window.onload = function() {
            // Initially show level selection and hide game area
            levelSelection.classList.remove('hidden');
            gameArea.classList.add('hidden');
        };

    </script>
</body>
</html>
