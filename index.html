<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>発達支援アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container bg-white shadow-xl rounded-2xl p-6 md:p-10 text-center">
        <!-- Main Title -->
        <h1 class="text-3xl md:text-5xl font-bold text-gray-800 mb-6 md:mb-10">ぶんしょうどっかいげーむ</h1>

        <!-- Story Selection Screen -->
        <div id="story-selection-screen" class="space-y-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-700 mb-4">すきなおはなしを えらんでね！</h2>
            <div id="story-options-container" class="grid gap-4 sm:grid-cols-2">
                <button data-story="ももたろう" class="story-select-btn py-4 px-8 rounded-full font-bold text-gray-800 bg-yellow-300 hover:bg-yellow-400 shadow-lg transform transition-all duration-300 hover:scale-105">
                    ももたろう
                </button>
                <button data-story="うさぎとかめ" class="story-select-btn py-4 px-8 rounded-full font-bold text-gray-800 bg-green-300 hover:bg-green-400 shadow-lg transform transition-all duration-300 hover:scale-105">
                    うさぎとかめ
                </button>
                <button data-story="おおきなかぶ" class="story-select-btn py-4 px-8 rounded-full font-bold text-gray-800 bg-red-300 hover:bg-red-400 shadow-lg transform transition-all duration-300 hover:scale-105">
                    おおきなかぶ
                </button>
                <button data-story="あかずきん" class="story-select-btn py-4 px-8 rounded-full font-bold text-gray-800 bg-blue-300 hover:bg-blue-400 shadow-lg transform transition-all duration-300 hover:scale-105">
                    あかずきん
                </button>
            </div>
        </div>

        <!-- Game Area -->
        <div id="game-area" class="space-y-6 hidden">
            <!-- Content Area (Story/Scenario) -->
            <div id="content-display" class="bg-gray-50 p-6 rounded-lg shadow-inner min-h-[150px] flex items-center justify-center text-left">
                <p id="game-text" class="text-lg md:text-xl text-gray-700 leading-relaxed"></p>
            </div>

            <!-- Question/Prompt Area -->
            <div id="prompt-display" class="bg-gray-100 p-4 rounded-lg shadow-sm">
                <p id="game-prompt" class="text-xl md:text-2xl font-bold text-gray-800"></p>
            </div>

            <!-- Answer Options -->
            <div id="options-container" class="grid gap-4 sm:grid-cols-2">
                <!-- Buttons will be injected here by JavaScript -->
            </div>
            
            <!-- Feedback Message -->
            <div id="feedback-container" class="min-h-[50px] flex items-center justify-center">
                <p id="feedback-message" class="text-2xl font-bold"></p>
            </div>

            <!-- Navigation Buttons and Loading Spinner -->
            <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                <button id="back-to-selection-btn" class="w-full sm:w-1/2 py-3 px-6 rounded-full font-bold text-gray-800 bg-gray-300 hover:bg-gray-400 shadow-lg transform transition-all duration-300 hover:scale-105">
                    もどる
                </button>
                <button id="next-btn" class="w-full sm:w-1/2 py-3 px-6 rounded-full font-bold text-white bg-green-500 hover:bg-green-600 shadow-lg transform transition-all duration-300 hover:scale-105 hidden">
                    つぎのもんだいへ
                </button>
                <div id="loading-spinner" class="hidden flex items-center justify-center py-4 px-8 w-full rounded-full bg-gray-400 text-white font-bold">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    せいさくちゅう...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for game state
        let readingData = [];
        let currentQuestionIndex = 0;

        // UI Elements
        const storySelectionScreen = document.getElementById('story-selection-screen');
        const gameArea = document.getElementById('game-area');
        const storyOptionsContainer = document.getElementById('story-options-container');
        const gameText = document.getElementById('game-text');
        const gamePrompt = document.getElementById('game-prompt');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextBtn = document.getElementById('next-btn');
        const backToSelectionBtn = document.getElementById('back-to-selection-btn');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Pre-defined fairy tales (hiragana only)
        const fairyTales = {
            "ももたろう": "むかしむかし、おじいさんとおばあさんがいました。おばあさんがかわでせんたくをしていると、おおきなももがながれてきました。ももをもちかえってわってみると、なかからげんきなこどもがうまれました。ももからうまれたので、ももたろうとよばれました。ももたろうは、きびだんごをもって、おにをたいじにしゅっぱつしました。とちゅうで、いぬとさるときじをなかまにして、おにがしまへむかいました。みんなでちからをあわせて、おにをたいじしました。",
            "うさぎとかめ": "うさぎと かめが くらべっこを することに なりました。うさぎは とても はやく はしりますが、かめは ゆっくりしか うごきません。うさぎは かめをばかにして、とちゅうでねてしまいました。かめはゆっくりとあるきつづけて、さいごにゴールしました。",
            "おおきなかぶ": "おじいさんとおばあさんがいました。おじいさんがかぶのたねをまきました。かぶはどんどんおおきくなりました。おじいさんがぬこうとしましたが、ぬけません。おばあさん、まご、いぬ、ねこ、ねずみがつぎつぎにてつだいました。みんなでちからをあわせて、「うんとこしょ、どっこいしょ」とひっぱると、おおきなかぶがやっとぬけました。",
            "あかずきん": "むかしむかし、かわいいおんなのこがいました。いつでもあかいいずきんをかぶっていたので、あかずきんとよばれていました。あるひ、おおかみがばあさんをたべて、あかずきんになりすましました。あかずきんがたずねると、おおかみはあかずきんもたべてしまいました。そのあと、きこりがおおかみのなかにいるふたりをみつけて、たすけだしました。"
        };

        /**
         * Retries a function with exponential backoff.
         * @param {Function} fn The function to retry.
         * @param {number} retries The number of retries left.
         * @param {number} delay The initial delay in milliseconds.
         */
        async function retryWithBackoff(fn, retries = 5, delay = 1000) {
            try {
                return await fn();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return retryWithBackoff(fn, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }
        
        /**
         * Fetches questions for a selected story from the Gemini API.
         * @param {string} storyKey The key of the selected story.
         */
        async function fetchQuestionsForStory(storyKey) {
            storySelectionScreen.classList.add('hidden');
            gameArea.classList.remove('hidden');

            loadingSpinner.classList.remove('hidden');
            nextBtn.classList.add('hidden');
            gameText.textContent = "";
            gamePrompt.textContent = "";
            optionsContainer.innerHTML = "";
            feedbackMessage.textContent = "";

            const storyText = fairyTales[storyKey];

            const prompt = `
            このどうわのぶんしょうをつかって、ねんちょうさんからしょうがくにねんせいのこどもがよめる、２つから４つのせんたくもんだいをJSON形式でつくってください。
            
            どうわ: ${storyText}
            
            もんだいを、'prompt'、'options'、'correct'の３つのきーをつかってつくってください。
            'options'には３つかせんたくしを、ひらがなだけをつかってかいてください。
            'correct'には、ただしいこたえのばんごうを０からはじまるすうじでいれてください。
            
            JSONのれいです:
            [
              {
                "prompt": "うさぎがすきなものはなに？",
                "options": ["りんご", "はっぱ", "にんじん"],
                "correct": 1
              },
              {
                "prompt": "どこにうさぎはいたの？",
                "options": ["うち", "そと", "こうえん"],
                "correct": 2
              }
            ]
            `;

            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "prompt": { "type": "STRING" },
                                "options": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                },
                                "correct": { "type": "NUMBER" }
                            },
                            "propertyOrdering": ["prompt", "options", "correct"]
                        }
                    }
                }
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await retryWithBackoff(async () => {
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        throw new Error(`API call failed: ${res.statusText}`);
                    }
                    return res.json();
                });
                
                const resultText = response.candidates[0].content.parts[0].text;
                const parsedResult = JSON.parse(resultText);

                readingData = parsedResult.map(q => ({
                    text: storyText,
                    ...q
                }));
                currentQuestionIndex = 0;
                displayQuestion();
            } catch (error) {
                console.error("API call failed:", error);
                gameText.textContent = "ごめんなさい、もんだいを つくることが できませんでした。もどって、もういちどためしてください。";
                nextBtn.classList.add('hidden');
                backToSelectionBtn.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Displays the current question.
         */
        function displayQuestion() {
            // Check if all questions have been answered
            if (currentQuestionIndex >= readingData.length) {
                gameText.textContent = "おしまい！よく がんばりました！";
                gamePrompt.textContent = "";
                optionsContainer.innerHTML = "";
                nextBtn.classList.remove('hidden');
                nextBtn.textContent = "ほかのおはなしをえらぶ";
                feedbackMessage.textContent = "";
                return;
            }

            const currentItem = readingData[currentQuestionIndex];
            
            // Reset UI for the new question
            gameText.textContent = currentItem.text;
            gamePrompt.textContent = currentItem.prompt;
            optionsContainer.innerHTML = "";
            nextBtn.classList.add('hidden');
            backToSelectionBtn.classList.remove('hidden');
            feedbackMessage.textContent = "";

            // Show UI elements for the question
            currentItem.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add(
                    'py-3', 'px-6', 'rounded-xl', 'font-bold', 'text-gray-800', 
                    'bg-gray-200', 'hover:bg-blue-300', 'transition-all', 'duration-300',
                    'shadow-sm', 'hover:shadow-lg', 'transform', 'hover:scale-105'
                );
                button.addEventListener('click', () => handleAnswer(index));
                optionsContainer.appendChild(button);
            });
        }

        /**
         * Handles the user's answer choice.
         * @param {number} selectedIndex The index of the selected option.
         */
        function handleAnswer(selectedIndex) {
            const currentItem = readingData[currentQuestionIndex];
            
            // Disable all buttons after an answer is selected
            Array.from(optionsContainer.children).forEach(button => {
                button.disabled = true;
            });

            if (selectedIndex === currentItem.correct) {
                feedbackMessage.textContent = "せいかい！";
                feedbackMessage.classList.add('text-green-600');
                feedbackMessage.classList.remove('text-red-600');
            } else {
                feedbackMessage.textContent = "ざんねん...もういちど かんがえてみよう！";
                feedbackMessage.classList.add('text-red-600');
                feedbackMessage.classList.remove('text-green-600');
            }
            nextBtn.classList.remove('hidden');
            nextBtn.textContent = "つぎのもんだいへ";
        }

        /**
         * Moves to the next question or fetches a new story.
         */
        function goToNextQuestion() {
            if (currentQuestionIndex >= readingData.length - 1) {
                // All questions answered, go back to story selection
                displayStorySelection();
            } else {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        /**
         * Displays the initial story selection screen.
         */
        function displayStorySelection() {
            gameArea.classList.add('hidden');
            storySelectionScreen.classList.remove('hidden');
        }

        // Event Listeners
        storyOptionsContainer.querySelectorAll('.story-select-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const storyKey = e.target.dataset.story;
                fetchQuestionsForStory(storyKey);
            });
        });

        nextBtn.addEventListener('click', goToNextQuestion);
        backToSelectionBtn.addEventListener('click', displayStorySelection);

        // Initial setup
        window.onload = function() {
            displayStorySelection();
        };

    </script>
</body>
</html>


