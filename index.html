<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>発達支援アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container bg-white shadow-xl rounded-2xl p-6 md:p-10 text-center">
        <!-- メインタイトル -->
        <h1 class="text-3xl md:text-5xl font-bold text-gray-800 mb-6 md:mb-10">ぶんしょうどっかいげーむ</h1>

        <!-- 物語選択画面 -->
        <div id="story-selection-screen" class="space-y-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-700 mb-4">すきなおはなしを えらんでね！</h2>
            <div id="story-options-container" class="grid gap-4 sm:grid-cols-2">
                <!-- JavaScriptでボタンが生成されます -->
            </div>
            <div id="loading-spinner-initial" class="hidden flex items-center justify-center py-4 px-8 w-full rounded-full bg-gray-400 text-white font-bold">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                よみこみちゅう...
            </div>
        </div>

        <!-- ゲームエリア -->
        <div id="game-area" class="space-y-6 hidden">
            <!-- 物語の表示エリア -->
            <div id="content-display" class="bg-gray-50 p-6 rounded-lg shadow-inner min-h-[150px] flex items-center justify-center text-left">
                <p id="game-text" class="text-lg md:text-xl text-gray-700 leading-relaxed"></p>
            </div>

            <!-- 質問エリア -->
            <div id="prompt-display" class="bg-gray-100 p-4 rounded-lg shadow-sm">
                <p id="game-prompt" class="text-xl md:text-2xl font-bold text-gray-800"></p>
            </div>

            <!-- 選択肢ボタン -->
            <div id="options-container" class="grid gap-4 sm:grid-cols-2">
                <!-- JavaScriptでボタンが生成されます -->
            </div>
            
            <!-- フィードバックメッセージ -->
            <div id="feedback-container" class="min-h-[50px] flex items-center justify-center">
                <p id="feedback-message" class="text-2xl font-bold"></p>
            </div>

            <!-- ナビゲーションボタン -->
            <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                <button id="back-to-selection-btn" class="w-full sm:w-1/2 py-3 px-6 rounded-full font-bold text-gray-800 bg-gray-300 hover:bg-gray-400 shadow-lg transform transition-all duration-300 hover:scale-105 hidden">
                    もどる
                </button>
                <button id="next-btn" class="w-full sm:w-1/2 py-3 px-6 rounded-full font-bold text-white bg-green-500 hover:bg-green-600 shadow-lg transform transition-all duration-300 hover:scale-105 hidden">
                    つぎのもんだいへ
                </button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let storyData = {};
        let currentStoryKey = null;
        let currentQuestions = [];
        let currentQuestionIndex = 0;

        // UIエレメント
        const storySelectionScreen = document.getElementById('story-selection-screen');
        const gameArea = document.getElementById('game-area');
        const storyOptionsContainer = document.getElementById('story-options-container');
        const gameText = document.getElementById('game-text');
        const gamePrompt = document.getElementById('game-prompt');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextBtn = document.getElementById('next-btn');
        const backToSelectionBtn = document.getElementById('back-to-selection-btn');
        const loadingSpinnerInitial = document.getElementById('loading-spinner-initial');

        /**
         * API呼び出しを共通化するヘルパー関数
         * @param {object} payload APIに送信するペイロード
         * @param {number} maxRetries リトライの最大回数
         * @returns {Promise<any>} APIからの応答（JSON）
         */
        async function fetchWithRetry(payload, maxRetries = 5) {
            let backoffDelay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        if (response.status === 401) throw new Error(`APIキーに問題があります。`);
                        if (response.status === 403) throw new Error(`APIアクセス権限がありません。管理者にお問い合わせください。`);
                        throw new Error(`データの読み込みに失敗しました (HTTP Status: ${response.status})`);
                    }

                    const result = await response.json();
                    const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("APIからの応答が空か、正しくない形式です。");

                    return JSON.parse(jsonText);
                } catch (error) {
                    console.error(`API呼び出しエラー (retry ${i + 1}/${maxRetries}):`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(res => setTimeout(res, backoffDelay));
                        backoffDelay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * 選択された物語の問題をセットして、ゲーム画面に切り替える
         * @param {string} storyKey 選択された物語のキー
         */
        async function startStoryGame(storyKey) {
            storySelectionScreen.classList.add('hidden');
            gameArea.classList.remove('hidden');
            currentStoryKey = storyKey;
            
            // 選択されたストーリーの詳細をAPIから取得
            await loadSpecificStory(storyKey);
            
            const selectedStory = storyData[currentStoryKey];
            currentQuestions = selectedStory.questions;
            currentQuestionIndex = 0;
            
            gameText.textContent = selectedStory.text;
            displayQuestion();
        }

        /**
         * 現在の問題を表示する
         */
        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                gameText.textContent = "おしまい！よく がんばりました！";
                gamePrompt.textContent = "もういちど ちょうせんする？";
                optionsContainer.innerHTML = "";
                feedbackMessage.textContent = "";
                nextBtn.classList.remove('hidden');
                nextBtn.textContent = "ほかのおはなしをえらぶ";
                backToSelectionBtn.classList.add('hidden');
                nextBtn.onclick = () => displayStorySelection();
                return;
            }

            const currentItem = currentQuestions[currentQuestionIndex];
            
            gamePrompt.textContent = currentItem.prompt;
            optionsContainer.innerHTML = "";
            nextBtn.classList.add('hidden');
            backToSelectionBtn.classList.remove('hidden');
            feedbackMessage.textContent = "";
            nextBtn.onclick = () => goToNextQuestion();

            currentItem.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add(
                    'py-3', 'px-6', 'rounded-xl', 'font-bold', 'text-gray-800', 
                    'bg-gray-200', 'hover:bg-blue-300', 'transition-all', 'duration-300',
                    'shadow-sm', 'hover:shadow-lg', 'transform', 'hover:scale-105'
                );
                button.addEventListener('click', () => handleAnswer(index));
                optionsContainer.appendChild(button);
            });
        }

        /**
         * ユーザーの回答を処理する
         * @param {number} selectedIndex 選択された選択肢のインデックス
         */
        function handleAnswer(selectedIndex) {
            const currentItem = currentQuestions[currentQuestionIndex];
            
            Array.from(optionsContainer.children).forEach(button => {
                button.disabled = true;
            });

            const correctAnswers = Array.isArray(currentItem.correct) ? currentItem.correct : [currentItem.correct];
            const isCorrect = correctAnswers.includes(selectedIndex);

            if (isCorrect) {
                feedbackMessage.textContent = "せいかい！";
                feedbackMessage.classList.add('text-green-600');
                feedbackMessage.classList.remove('text-red-600');
                const correctButton = optionsContainer.children[selectedIndex];
                if(correctButton) {
                     correctButton.classList.remove('bg-gray-200', 'hover:bg-blue-300');
                     correctButton.classList.add('bg-green-400');
                }
            } else {
                feedbackMessage.textContent = "ざんねん...もういちど かんがえてみよう！";
                feedbackMessage.classList.add('text-red-600');
                feedbackMessage.classList.remove('text-green-600');
                const selectedButton = optionsContainer.children[selectedIndex];
                if(selectedButton) {
                    selectedButton.classList.remove('bg-gray-200', 'hover:bg-blue-300');
                    selectedButton.classList.add('bg-red-400');
                }
                correctAnswers.forEach(correctIndex => {
                    const correctButton = optionsContainer.children[correctIndex];
                    if(correctButton) {
                        correctButton.classList.remove('bg-gray-200', 'hover:bg-blue-300');
                        correctButton.classList.add('bg-green-400');
                    }
                });
            }
            nextBtn.classList.remove('hidden');
        }

        /**
         * 次の問題に進む
         */
        function goToNextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        /**
         * 物語の選択画面を表示する
         */
        function displayStorySelection() {
            gameArea.classList.add('hidden');
            storySelectionScreen.classList.remove('hidden');
            backToSelectionBtn.classList.add('hidden');
        }

        /**
         * 物語のタイトルをAPIから取得して、ボタンを生成する
         */
        async function loadStoryTitles() {
            loadingSpinnerInitial.classList.remove('hidden');
            const prompt = `日本昔話の物語名を配列で生成してください。物語は「ももたろう」「おおきなかぶ」「うさぎとかめ」「あかずきん」を含みます。`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: { type: "ARRAY", items: { type: "STRING" } }
                }
            };
            
            try {
                const storyTitles = await fetchWithRetry(payload);
                storyOptionsContainer.innerHTML = '';
                storyTitles.forEach(title => {
                    const button = document.createElement('button');
                    button.textContent = title;
                    button.dataset.story = title;
                    button.classList.add(
                        'story-select-btn', 'py-4', 'px-8', 'rounded-full', 'font-bold',
                        'text-gray-800', 'bg-yellow-300', 'hover:bg-yellow-400',
                        'shadow-lg', 'transform', 'transition-all', 'duration-300',
                        'hover:scale-105'
                    );
                    button.addEventListener('click', (e) => {
                        const storyKey = e.target.dataset.story;
                        startStoryGame(storyKey);
                    });
                    storyOptionsContainer.appendChild(button);
                });
            } catch (error) {
                const errorMessage = document.createElement('p');
                errorMessage.textContent = `エラーが発生しました: ${error.message}`;
                errorMessage.classList.add('text-red-500', 'mt-4', 'font-bold');
                storyOptionsContainer.appendChild(errorMessage);
            } finally {
                loadingSpinnerInitial.classList.add('hidden');
            }
        }

        /**
         * 指定されたストーリーの詳細をAPIから取得する
         * @param {string} storyTitle
         */
        async function loadSpecificStory(storyTitle) {
            loadingSpinnerInitial.classList.remove('hidden');
            const prompt = `日本昔話の「${storyTitle}」について、簡単なあらすじと、その内容に関する選択式の問題を3つ作成してください。JSON形式で出力し、キーを物語の名前（「${storyTitle}」）としてください。物語のオブジェクトは、テキスト（"text"）と質問の配列（"questions"）を含み、各質問オブジェクトはプロンプト（"prompt"）、選択肢の配列（"options"）、そして正解のインデックス（"correct"）を含みます。`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            [storyTitle]: {
                                type: "OBJECT",
                                properties: {
                                    text: { type: "STRING" },
                                    questions: {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                prompt: { type: "STRING" },
                                                options: { type: "ARRAY", items: { type: "STRING" } },
                                                correct: { type: "NUMBER" }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            };
            
            try {
                const storyDetails = await fetchWithRetry(payload);
                storyData[storyTitle] = storyDetails[storyTitle];
            } catch (error) {
                console.error(`ストーリー詳細の読み込みに失敗しました:`, error);
                throw new Error(`ストーリー詳細の読み込みに失敗しました: ${error.message}`);
            } finally {
                loadingSpinnerInitial.classList.add('hidden');
            }
        }

        // イベントリスナー
        nextBtn.addEventListener('click', goToNextQuestion);
        backToSelectionBtn.addEventListener('click', displayStorySelection);

        // 初期設定
        window.onload = function() {
            loadStoryTitles();
        };

    </script>
</body>
</html>




    </script>
</body>
</html>
