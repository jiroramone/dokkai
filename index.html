<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>発達支援アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f3f4f6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="container bg-white shadow-xl rounded-2xl p-6 md:p-10 text-center">
        <!-- Main Title -->
        <h1 class="text-3xl md:text-5xl font-bold text-gray-800 mb-6 md:mb-10">ぶんしょうどっかいげーむ</h1>

        <!-- Story Selection Screen -->
        <div id="story-selection-screen" class="space-y-6">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-700 mb-4">すきなおはなしを えらんでね！</h2>
            <div id="story-options-container" class="grid gap-4 sm:grid-cols-2">
                <!-- Buttons will be generated by JavaScript -->
            </div>
            <div id="loading-spinner-initial" class="hidden flex items-center justify-center py-4 px-8 w-full rounded-full bg-gray-400 text-white font-bold">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                よみこみちゅう...
            </div>
        </div>

        <!-- Game Area -->
        <div id="game-area" class="space-y-6 hidden">
            <!-- Content Area (Story/Scenario) -->
            <div id="content-display" class="bg-gray-50 p-6 rounded-lg shadow-inner min-h-[150px] flex items-center justify-center text-left">
                <p id="game-text" class="text-lg md:text-xl text-gray-700 leading-relaxed"></p>
            </div>

            <!-- Question/Prompt Area -->
            <div id="prompt-display" class="bg-gray-100 p-4 rounded-lg shadow-sm">
                <p id="game-prompt" class="text-xl md:text-2xl font-bold text-gray-800"></p>
            </div>

            <!-- Answer Options -->
            <div id="options-container" class="grid gap-4 sm:grid-cols-2">
                <!-- Buttons will be injected here by JavaScript -->
            </div>
            
            <!-- Feedback Message -->
            <div id="feedback-container" class="min-h-[50px] flex items-center justify-center">
                <p id="feedback-message" class="text-2xl font-bold"></p>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 items-center justify-center">
                <button id="back-to-selection-btn" class="w-full sm:w-1/2 py-3 px-6 rounded-full font-bold text-gray-800 bg-gray-300 hover:bg-gray-400 shadow-lg transform transition-all duration-300 hover:scale-105 hidden">
                    もどる
                </button>
                <button id="next-btn" class="w-full sm:w-1/2 py-3 px-6 rounded-full font-bold text-white bg-green-500 hover:bg-green-600 shadow-lg transform transition-all duration-300 hover:scale-105 hidden">
                    つぎのもんだいへ
                </button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let storyData = {};
        let currentStoryKey = null; // 選択されたお話のキーを保存する
        let currentQuestions = [];
        let currentQuestionIndex = 0;

        // UIエレメント
        const storySelectionScreen = document.getElementById('story-selection-screen');
        const gameArea = document.getElementById('game-area');
        const storyOptionsContainer = document.getElementById('story-options-container');
        const gameText = document.getElementById('game-text');
        const gamePrompt = document.getElementById('game-prompt');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const nextBtn = document.getElementById('next-btn');
        const backToSelectionBtn = document.getElementById('back-to-selection-btn');
        const loadingSpinnerInitial = document.getElementById('loading-spinner-initial');

        /**
         * 選択された物語の問題をセットして、ゲーム画面に切り替える
         * @param {string} storyKey 選択された物語のキー
         */
        function startStoryGame(storyKey) {
            storySelectionScreen.classList.add('hidden');
            gameArea.classList.remove('hidden');

            // 選択されたお話のキーとデータを保存
            currentStoryKey = storyKey;
            const selectedStory = storyData[currentStoryKey];
            currentQuestions = selectedStory.questions;
            currentQuestionIndex = 0;
            
            // お話の文章を一度だけ表示する
            gameText.textContent = selectedStory.text;

            displayQuestion();
        }

        /**
         * 現在の問題を表示する
         */
        function displayQuestion() {
            // 全問終了後の処理
            if (currentQuestionIndex >= currentQuestions.length) {
                gameText.textContent = "おしまい！よく がんばりました！";
                gamePrompt.textContent = "もういちど ちょうせんする？";
                optionsContainer.innerHTML = "";
                feedbackMessage.textContent = "";
                nextBtn.classList.remove('hidden');
                nextBtn.textContent = "ほかのおはなしをえらぶ";
                backToSelectionBtn.classList.add('hidden'); // 「もどる」ボタンを非表示
                
                nextBtn.onclick = () => displayStorySelection(); // クリックイベントを再定義

                return;
            }

            const currentItem = currentQuestions[currentQuestionIndex];
            
            // UIをリセット
            gamePrompt.textContent = currentItem.prompt;
            optionsContainer.innerHTML = "";
            nextBtn.classList.add('hidden');
            backToSelectionBtn.classList.remove('hidden'); // 「もどる」ボタンを表示
            feedbackMessage.textContent = "";
            
            nextBtn.onclick = () => goToNextQuestion(); // クリックイベントを元に戻す

            // 選択肢ボタンを表示
            currentItem.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add(
                    'py-3', 'px-6', 'rounded-xl', 'font-bold', 'text-gray-800', 
                    'bg-gray-200', 'hover:bg-blue-300', 'transition-all', 'duration-300',
                    'shadow-sm', 'hover:shadow-lg', 'transform', 'hover:scale-105'
                );
                button.addEventListener('click', () => handleAnswer(index));
                optionsContainer.appendChild(button);
            });
        }

        /**
         * ユーザーの回答を処理する
         * @param {number} selectedIndex 選択された選択肢のインデックス
         */
        function handleAnswer(selectedIndex) {
            const currentItem = currentQuestions[currentQuestionIndex];
            
            // ボタンを無効化
            Array.from(optionsContainer.children).forEach(button => {
                button.disabled = true;
            });

            // 正解が配列かどうかをチェック（複数選択問題の可能性）
            const isCorrectArray = Array.isArray(currentItem.correct);
            const isCorrect = isCorrectArray 
                ? currentItem.correct.includes(selectedIndex)
                : selectedIndex === currentItem.correct;

            if (isCorrect) {
                feedbackMessage.textContent = "せいかい！";
                feedbackMessage.classList.add('text-green-600');
                feedbackMessage.classList.remove('text-red-600');
                const correctButton = optionsContainer.children[selectedIndex];
                if(correctButton) {
                     correctButton.classList.remove('bg-gray-200', 'hover:bg-blue-300');
                     correctButton.classList.add('bg-green-400');
                }
            } else {
                feedbackMessage.textContent = "ざんねん...もういちど かんがえてみよう！";
                feedbackMessage.classList.add('text-red-600');
                feedbackMessage.classList.remove('text-green-600');
                const selectedButton = optionsContainer.children[selectedIndex];
                if(selectedButton) {
                    selectedButton.classList.remove('bg-gray-200', 'hover:bg-blue-300');
                    selectedButton.classList.add('bg-red-400');
                }
                // 正解のボタンをハイライト表示
                const correctIndices = isCorrectArray ? currentItem.correct : [currentItem.correct];
                correctIndices.forEach(correctIndex => {
                    const correctButton = optionsContainer.children[correctIndex];
                    if(correctButton) {
                        correctButton.classList.remove('bg-gray-200', 'hover:bg-blue-300');
                        correctButton.classList.add('bg-green-400');
                    }
                });
            }
            nextBtn.classList.remove('hidden');
        }

        /**
         * 次の問題に進む
         */
        function goToNextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        /**
         * 物語の選択画面を表示する
         */
        function displayStorySelection() {
            gameArea.classList.add('hidden');
            storySelectionScreen.classList.remove('hidden');
            backToSelectionBtn.classList.add('hidden'); // 選択画面では「もどる」ボタンは不要
        }

        /**
         * stories.jsonファイルを読み込み、物語選択ボタンを生成する
         */
        async function loadStories() {
            loadingSpinnerInitial.classList.remove('hidden');
            let backoffDelay = 1000; // 1秒
            const maxRetries = 5;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    // stories.jsonファイルをAPIで取得
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const payload = {
                        contents: [{
                            role: "user",
                            parts: [{
                                text: `Provide the stories.json data. The JSON should be in the following format: a single JSON object where keys are the story titles (e.g., "ももたろう") and values are objects containing 'text' (the story string) and 'questions' (an array of question objects). Each question object must have 'prompt' (string), 'options' (array of strings), and 'correct' (the correct index as a number OR an array of numbers for multi-select questions).`
                            }]
                        }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "ももたろう": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "text": { "type": "STRING" },
                                            "questions": {
                                                "type": "ARRAY",
                                                "items": {
                                                    "type": "OBJECT",
                                                    "properties": {
                                                        "prompt": { "type": "STRING" },
                                                        "options": {
                                                            "type": "ARRAY",
                                                            "items": { "type": "STRING" }
                                                        },
                                                        // 正解を配列として一貫して扱うように変更
                                                        "correct": {
                                                            "type": "ARRAY",
                                                            "items": { "type": "NUMBER" }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    "おおきなかぶ": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "text": { "type": "STRING" },
                                            "questions": {
                                                "type": "ARRAY",
                                                "items": {
                                                    "type": "OBJECT",
                                                    "properties": {
                                                        "prompt": { "type": "STRING" },
                                                        "options": {
                                                            "type": "ARRAY",
                                                            "items": { "type": "STRING" }
                                                        },
                                                        // 正解を配列として一貫して扱うように変更
                                                        "correct": {
                                                            "type": "ARRAY",
                                                            "items": { "type": "NUMBER" }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    "うさぎとかめ": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "text": { "type": "STRING" },
                                            "questions": {
                                                "type": "ARRAY",
                                                "items": {
                                                    "type": "OBJECT",
                                                    "properties": {
                                                        "prompt": { "type": "STRING" },
                                                        "options": {
                                                            "type": "ARRAY",
                                                            "items": { "type": "STRING" }
                                                        },
                                                        // 正解を配列として一貫して扱うように変更
                                                        "correct": {
                                                            "type": "ARRAY",
                                                            "items": { "type": "NUMBER" }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                },
                                "propertyOrdering": ["ももたろう", "おおきなかぶ", "うさぎとかめ"]
                            }
                        }
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) {
                        throw new Error("API response is empty or malformed");
                    }
                    storyData = JSON.parse(jsonText);
                    
                    // ボタンを動的に生成
                    storyOptionsContainer.innerHTML = '';
                    for (const key in storyData) {
                        const button = document.createElement('button');
                        button.textContent = key;
                        button.dataset.story = key;
                        button.classList.add(
                            'story-select-btn', 'py-4', 'px-8', 'rounded-full', 'font-bold',
                            'text-gray-800', 'bg-yellow-300', 'hover:bg-yellow-400',
                            'shadow-lg', 'transform', 'transition-all', 'duration-300',
                            'hover:scale-105'
                        );
                        button.addEventListener('click', (e) => {
                            const storyKey = e.target.dataset.story;
                            startStoryGame(storyKey);
                        });
                        storyOptionsContainer.appendChild(button);
                    }
                    // 成功した場合はループを抜ける
                    break; 

                } catch (error) {
                    console.error(`Error loading stories (retry ${i + 1}/${maxRetries}):`, error);
                    if (i < maxRetries - 1) {
                        await new Promise(res => setTimeout(res, backoffDelay));
                        backoffDelay *= 2;
                    } else {
                        const errorMessage = document.createElement('p');
                        errorMessage.textContent = 'おはなしのデータをよみこむことができませんでした。もういちどためしてください。';
                        errorMessage.classList.add('text-red-500', 'mt-4');
                        storyOptionsContainer.appendChild(errorMessage);
                    }
                } finally {
                    if (i === maxRetries - 1) {
                        loadingSpinnerInitial.classList.add('hidden');
                    }
                }
            }
        }

        // イベントリスナー
        nextBtn.addEventListener('click', goToNextQuestion);
        backToSelectionBtn.addEventListener('click', displayStorySelection);

        // 初期設定
        window.onload = function() {
            loadStories();
        };

    </script>
</body>
</html>
